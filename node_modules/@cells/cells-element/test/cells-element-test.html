<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>cells-element test</title>
  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../node_modules/mocha/mocha.js"></script>
  <script src="../node_modules/wct-mocha/wct-mocha.js"></script>
  <script src="../node_modules/chai/chai.js"></script>
  <script src="../node_modules/sinon/pkg/sinon.js"></script>
  <script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
  <script src="../node_modules/sinon-chai/lib/sinon-chai.js"></script>
</head>

<body>

  <test-fixture id="default">
    <template>
      <cells-element></cells-element>
    </template>
  </test-fixture>

  <script type="module">
    import './test.js';

    const commands = [
      { command: 'subscribe', bridgeFn: 'registerInConnection' },
      { command: 'publish', bridgeFn: 'publish' },
      { command: 'publishOn', bridgeFn: 'registerOutConnection' },
      { command: 'navigate', bridgeFn: 'navigate' },
    ];

    suite('cells-element', () => {

      let el;
      let elementShadowRoot;

      setup(async () => {
        el = fixture('default');
      
        commands.forEach(config => {
            const { bridgeFn } = config;
            window.cells = window.cells || {};
            window.cells[bridgeFn] = () => {};
          });

        elementShadowRoot = el.shadowRoot;
        return await el.updateComplete;
      });


      commands.forEach(config => {
          test('it should call cells bridge with correct commands', async () => {
            const { command, bridgeFn } = config;
            const bridgeSpy = sinon.spy(window.cells, bridgeFn);
            await el.updateComplete;
            el[command]();

            expect(bridgeSpy).calledOnce;
          });
        });

        test('it should throw an error when calling non-existent bridge commands', async () => {
          const command = 'myFakeBridgeCommand';
          const fnToTest = () => {
            el.__callCellsBridge(command, []);
          };
          expect(fnToTest).to.throw(`WARNING: Invalid cells bridge command execution: ${command}.`);
        });

        suite('cells bridge is not available', () => {
        setup(function() {
          commands.forEach(config => {
            window.cells = null;
          });
        });

        commands.forEach(config => {
          test('it should queue cells bridge commands for later execution', () => {
            const { command, bridgeFn } = config;

            el[command]();

            const queuedBridgeCommand = window.cellsBridgeQueue.find(item => item.command === bridgeFn);

            expect(queuedBridgeCommand).exist;
          });
        });
      });

    });
  </script>

</body>

</html>