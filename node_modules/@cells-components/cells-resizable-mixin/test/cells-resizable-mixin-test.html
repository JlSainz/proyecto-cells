<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<html>
<head>
  <title>cells-resizable-mixin tests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../node_modules/mocha/mocha.js"></script>
  <script src="../node_modules/wct-mocha/wct-mocha.js"></script>
  <script src="../node_modules/chai/chai.js"></script>
  <script src="../node_modules/sinon/pkg/sinon.js"></script>
  <script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
  <script src="../node_modules/sinon-chai/lib/sinon-chai.js"></script>
</head>
<body>

  <x-resizer-parent>
    <x-resizable></x-resizable>
  </x-resizer-parent>

  <test-fixture id="TestElement">
    <template>
      <test-element></test-element>
    </template>
  </test-fixture>

  <test-fixture id="ResizableAndShadowBoundaries">
    <template>
      <x-light-resizable></x-light-resizable>
    </template>
  </test-fixture>

  <script type="module">
    import { LitElement, html, dedupingMixin, CellsResizableMixin } from './test.js';

    class XResizable extends CellsResizableMixin(LitElement) {
      static get is() {
        return 'x-resizable';
      }
    }
    customElements.define(XResizable.is, XResizable);

    class XResizerParent extends CellsResizableMixin(LitElement) {
      static get is() {
        return 'x-resizer-parent';
      }
    }
    customElements.define(XResizerParent.is, XResizerParent);

    class XResizerParentFiltered extends CellsResizableMixin(LitElement) {
      static get is() {
        return 'x-resizer-parent-filtered';
      }
      constructor() {
        super();
        this.active = null;
      }
      resizerShouldNotify(el) {
        return (el == this.active);
      }
    }
    customElements.define(XResizerParentFiltered.is, XResizerParentFiltered);

    class XResizableInShadow extends LitElement {
      static get is() {
        return 'x-resizable-in-shadow';
      }
      render() {
        return html`
          <div>
            <x-resizable id="resizable"></x-resizable>
          </div>
        `;
      }

    }
    customElements.define(XResizableInShadow.is, XResizableInShadow);

    class TestElement extends LitElement {
      static get is() {
        return 'test-element';
      }
      render() {
        return html`
          <!-- Normal resizable parent with child resizables -->
          <x-resizer-parent id="parent">
            <x-resizable id="child1a"></x-resizable>
            <div>
              <x-resizable id="child1b"></x-resizable>
            </div>
            <x-resizable-in-shadow id="shadow1c"></x-resizable-in-shadow>
            <div>
              <x-resizable-in-shadow id="shadow1d"></x-resizable-in-shadow>
            </div>
          </x-resizer-parent>

          <!-- Resizable parent using resizerShouldNotify, with child resizables -->
          <x-resizer-parent-filtered id="parentFiltered">
            <x-resizable id="child2a"></x-resizable>
            <div>
              <x-resizable id="child2b"></x-resizable>
            </div>
            <x-resizable-in-shadow id="shadow2c"></x-resizable-in-shadow>
            <div>
              <x-resizable-in-shadow id="shadow2d"></x-resizable-in-shadow>
            </div>
          </x-resizer-parent-filtered>
        `;
      }
    }
    customElements.define(TestElement.is, TestElement);

    /** @mixinFunction */
    export const ObserveCellsResizeMixin = dedupingMixin(superClass => {
      return class extends superClass {
        static get properties() {
          return {
            cellsResizeCount: {
              type: Number,
              attribute: 'cells-resize-count'
            }
          }
        }
        constructor() {
          super();
          this.cellsResizeCount = 0;
          this.addEventListener('cells-resize', this._incrementCellsResizeCount);
        }
        _incrementCellsResizeCount() {
          this.cellsResizeCount++;
        }
      }
    });

    class XShadowResizable extends ObserveCellsResizeMixin(CellsResizableMixin(LitElement)) {
      static get is() {
        return 'x-shadow-resizable';
      }
      render() {
        return html`
          <div></div>
        `;
      }
    }
    customElements.define(XShadowResizable.is, XShadowResizable);

    class XLightResizable extends ObserveCellsResizeMixin(CellsResizableMixin(LitElement)) {
      static get is() {
        return 'x-light-resizable';
      }
      render() {
        return html`
          <x-shadow-resizable id="childResizable1"></x-shadow-resizable>
          <x-shadow-resizable id="childResizable2"></x-shadow-resizable>
        `;
      }
    }
    customElements.define(XLightResizable.is, XLightResizable);

    suite('basic', () => {
      function ListenForResize(el, expectsResize) {
        var listener = function(event) {
          var target = event.path ? event.path[0] : event.target;
          pendingNotifications--;
        };

        if (expectsResize !== false) {
          pendingNotifications++;
        }

        el.addEventListener('cells-resize', listener);

        return {
          el: el,
          remove: function() {
            el.removeEventListener('cells-resize', listener);
          }
        };
      }

      function RemoveListeners(listeners) {
        listeners.forEach(function(listener) {
          listener.remove();
        });
      }

      let pendingNotifications;
      let testEl;

      setup(async () => {
        pendingNotifications = 0;
        testEl = fixture('TestElement');
        await testEl.updateComplete;
      });

      suite('x-resizer-parent', () => {
        let parent;
        let child1a;
        let child1b;
        let shadow1cResizable;
        let shadow1dResizable;
        let shadow2cResizable;

        setup(() => {
          parent = testEl.shadowRoot.querySelector('#parent');
          child1a = testEl.shadowRoot.querySelector('#child1a');
          child1b = testEl.shadowRoot.querySelector('#child1b');
          shadow1cResizable = testEl.shadowRoot.querySelector('#shadow1c').shadowRoot.querySelector('#resizable');
          shadow1dResizable = testEl.shadowRoot.querySelector('#shadow1d').shadowRoot.querySelector('#resizable');
        });

        test('notify resizables from window', () => {
          var listeners = [
            ListenForResize(parent),
            ListenForResize(child1a),
            ListenForResize(child1b),
            ListenForResize(shadow1cResizable),
            ListenForResize(shadow1dResizable)
          ];

          window.dispatchEvent(new CustomEvent('resize', { bubbles: false }));
          expect(pendingNotifications).to.be.eql(0);

          RemoveListeners(listeners);
        });

        test('notify resizables from parent', function() {
          var listeners = [
            ListenForResize(parent),
            ListenForResize(child1a),
            ListenForResize(child1b),
            ListenForResize(shadow1cResizable),
            ListenForResize(shadow1dResizable)
          ];

          parent.notifyResize();
          expect(pendingNotifications).to.be.eql(0);
          RemoveListeners(listeners);
        });

        test('detach resizables then notify parent', async () => {
          sinon.spy(child1a, 'notifyResize');
          sinon.spy(shadow1cResizable, 'notifyResize');
          sinon.spy(child1b, 'notifyResize');
          sinon.spy(shadow1dResizable, 'notifyResize');

          var firstElementToRemove = child1a;
          var firstElementParent = firstElementToRemove.parentNode;
          var secondElementToRemove = shadow1cResizable;
          var secondElementParent = secondElementToRemove.parentNode;

          firstElementParent.removeChild(firstElementToRemove);
          secondElementParent.removeChild(secondElementToRemove);

          await testEl.updateComplete;

          parent.notifyResize();

          expect(child1a.notifyResize.callCount).to.be.equal(0);
          expect(shadow1cResizable.notifyResize.callCount).to.be.equal(0);
          expect(child1b.notifyResize.callCount).to.be.equal(1);
          expect(shadow1dResizable.notifyResize.callCount).to.be.equal(1);
        });

        test('detach parent then notify window', (done) => {
          var listeners = [
            ListenForResize(parent, false),
            ListenForResize(child1a, false),
            ListenForResize(child1b, false),
            ListenForResize(shadow1cResizable, false),
            ListenForResize(shadow1dResizable, false)
          ];

          var el = testEl.shadowRoot.querySelector('#parent');
          el.parentNode.removeChild(el);
          requestAnimationFrame(() => {
            window.dispatchEvent(new CustomEvent('resize', {bubbles: false}));
            expect(pendingNotifications).to.be.eql(0);
            RemoveListeners(listeners);
            done();
          });
        });
      });

      suite('x-resizer-parent-filtered', function() {
        let parentFiltered;
        let child2a;
        let child2b;
        let shadow2cResizable;
        let shadow2dResizable;

        setup(() => {
          parentFiltered = testEl.shadowRoot.querySelector('#parentFiltered');
          child2a = testEl.shadowRoot.querySelector('#child2a');
          child2b = testEl.shadowRoot.querySelector('#child2b');
          shadow2cResizable = testEl.shadowRoot.querySelector('#shadow2c').shadowRoot.querySelector('#resizable');
          shadow2dResizable = testEl.shadowRoot.querySelector('#shadow2d').shadowRoot.querySelector('#resizable');
        });

        test('notify resizables from window', function() {
          var listeners = [
            ListenForResize(parentFiltered),
            ListenForResize(child2a),
            ListenForResize(child2b, false),
            ListenForResize(shadow2cResizable, false),
            ListenForResize(shadow2dResizable, false)
          ];

          parentFiltered.active = child2a;

          window.dispatchEvent(new CustomEvent('resize', {bubbles: false}));
          expect(pendingNotifications).to.be.eql(0);
          RemoveListeners(listeners);
        });

        test('notify resizables from parent', function() {
          var listeners = [
            ListenForResize(parentFiltered),
            ListenForResize(child2a),
            ListenForResize(child2b, false),
            ListenForResize(shadow2cResizable, false),
            ListenForResize(shadow2dResizable, false)
          ];

          parentFiltered.active = child2a;

          parentFiltered.notifyResize();
          expect(pendingNotifications).to.be.eql(0);
          RemoveListeners(listeners);
        });

        test('detach resizables then notify parent', function() {
          var listeners = [
            ListenForResize(parentFiltered),
            ListenForResize(child2a, false),
            ListenForResize(child2b, false),
            ListenForResize(shadow2cResizable, false),
            ListenForResize(shadow2dResizable)
          ];

          var el = testEl.shadowRoot.querySelector('#child2a');
          el.parentNode.removeChild(el);
          el = testEl.shadowRoot.querySelector('#shadow2c');
          el.parentNode.removeChild(el);

          parentFiltered.active = shadow2dResizable;

          parentFiltered.notifyResize();
          expect(pendingNotifications).to.be.eql(0);
          RemoveListeners(listeners);
        });
      });
    });

    suite('imports order', () => {
      test('resizable children and parent updated', () => {
        var parent = document.querySelector('x-resizer-parent');
        var child = parent.firstElementChild;
        assert.deepEqual(parent._interestedResizables, [child], 'resizable children ok');
        assert.equal(child._parentResizable, parent, 'resizable parent ok');
      });
    });

    suite('cells-resizable-mixin', () => {
      let resizable;

      suite('events across shadow boundaries', () => {
        setup(async () => {
          resizable = fixture('ResizableAndShadowBoundaries');
          await resizable.updateComplete;
        });

        suite('ancestor\'s cells-resize', () => {
          test('only fires once for a notifying shadow descendent', () => {
            const initialCount = resizable.cellsResizeCount;

            resizable.shadowRoot.querySelector('#childResizable1').notifyResize();

            expect(resizable.cellsResizeCount - initialCount).to.be.equal(1);
          });

          test('only fires once when notifying descendent observables', () => {
            const initialCount = resizable.cellsResizeCount;

            resizable.notifyResize();

            expect(resizable.cellsResizeCount - initialCount).to.be.equal(1);
          });
        });

        suite('descendant\'s cells-resize', () => {
          test('only fires once for a notifying shadow root', () => {
            var childResizable1InitialCount = resizable.shadowRoot.querySelector('#childResizable1').cellsResizeCount;
            var childResizable2InitialCount = resizable.shadowRoot.querySelector('#childResizable2').cellsResizeCount;

            resizable.notifyResize();

            expect(resizable.shadowRoot.querySelector('#childResizable1').cellsResizeCount - childResizable1InitialCount).to.be.equal(1);
            expect(resizable.shadowRoot.querySelector('#childResizable2').cellsResizeCount - childResizable2InitialCount).to.be.equal(1);
          });

          test('only fires once for a notifying descendent observable', () => {
            var initialCount = resizable.shadowRoot.querySelector('#childResizable1').cellsResizeCount;

            resizable.shadowRoot.querySelector('#childResizable1').notifyResize();

            expect(resizable.shadowRoot.querySelector('#childResizable1').cellsResizeCount - initialCount).to.be.equal(1);
          });
        });

        suite('window\'s resize', () => {
          test('causes all cells-resize events to fire once', () => {
            var rootInitialCount = resizable.cellsResizeCount;
            var childResizable1InitialCount = resizable.shadowRoot.querySelector('#childResizable1').cellsResizeCount;
            var childResizable2InitialCount = resizable.shadowRoot.querySelector('#childResizable2').cellsResizeCount;

            window.dispatchEvent(new CustomEvent('resize'));

            expect(resizable.cellsResizeCount - rootInitialCount).to.be.equal(1);
            expect(resizable.shadowRoot.querySelector('#childResizable1').cellsResizeCount - childResizable1InitialCount).to.be.equal(1);
            expect(resizable.shadowRoot.querySelector('#childResizable2').cellsResizeCount - childResizable2InitialCount).to.be.equal(1);
          });
        });
      });
    });
  </script>
</body>
</html>
